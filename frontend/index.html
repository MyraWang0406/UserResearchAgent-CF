<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Research Agent Â· Conversation OS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    :root {
      --blue-main: #2f6bff;
      --blue-soft: #eaf0ff;
      --accent-main: #ef4444;
      --accent-soft: #fee2e2;
      --accent-text: #991b1b;
      --silver: #f4f6f8;
      --silver-border: #d9dee5;
      --text-main: #1f2937;
      --text-sub: #6b7280;
      --wave: rgba(47,107,255,0.08);
      --ok: #0ea5e9;
      --warn: #f59e0b;
      --bad: #ef4444;
    }
    * { box-sizing: border-box; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB"; }
    body {
      margin: 0; padding: 0;
      background:
        radial-gradient(circle at 20% 0%, var(--wave), transparent 40%),
        radial-gradient(circle at 80% 20%, var(--wave), transparent 45%),
        #ffffff;
      color: var(--text-main);
    }
    header { padding: 28px 40px 18px; border-bottom: 1px solid var(--silver-border); position: relative; }
    header h1 { margin: 0; font-size: 26px; color: var(--accent-main); }
    header p { margin-top: 6px; color: var(--text-sub); font-size: 14px; }
    .lang-toggle {
      position: absolute; top: 28px; right: 40px;
      display: flex; gap: 6px; font-size: 13px; align-items: center;
    }
    .lang-btn {
      padding: 6px 12px; border-radius: 8px; border: 1px solid var(--silver-border);
      background: #fff; color: var(--text-sub); cursor: pointer;
    }
    .lang-btn.active { border-color: var(--accent-main); color: var(--accent-main); background: var(--accent-soft); }
    .lang-btn:hover { border-color: var(--accent-main); }
    main { padding: 24px 40px 60px; }
    .grid { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 24px; }
    .card {
      background: var(--silver);
      border: 1px solid var(--silver-border);
      border-radius: 14px;
      padding: 18px 20px;
    }
    .card h2 { margin: 0 0 12px; font-size: 18px; color: var(--accent-main); }
    label { display:block; font-size: 13px; margin-top: 12px; margin-bottom: 6px; color: var(--text-sub); }
    select, textarea, input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--silver-border);
      font-size: 14px;
      background: #fff;
    }
    textarea { min-height: 78px; resize: vertical; }
    .row { display:flex; gap: 12px; }
    .row > div { flex: 1; }
    .tabs { display:flex; gap: 10px; margin-bottom: 14px; }
    .tab {
      border: 1px solid var(--silver-border);
      background: #fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      color: var(--text-sub);
      user-select: none;
    }
    .tab.active { border-color: var(--accent-main); color: var(--accent-main); background: var(--accent-soft); }
    .btn {
      margin-top: 16px;
      padding: 12px 18px;
      border-radius: 12px;
      border: none;
      background: var(--accent-main);
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    .btn.secondary { background: #111827; }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }
    .output {
      background: #fff;
      border: 1px dashed var(--silver-border);
      border-radius: 12px;
      padding: 14px;
      font-size: 13px;
      line-height: 1.65;
      white-space: pre-wrap;
      min-height: 420px;
    }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background: var(--accent-soft); color: var(--accent-text); border: 1px solid rgba(239,68,68,.35); font-size: 12px; margin-right: 6px; }
    .hint { color: var(--text-sub); font-size: 12px; margin-top: 8px; }
    .small { font-size: 12px; color: var(--text-sub); }
    footer { padding: 22px 40px; border-top: 1px solid var(--silver-border); color: var(--text-sub); font-size: 13px; }
    a { color: var(--accent-main); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .tab-c-only { display: none; }
    .tab-c-only.visible { display: block; }
    .tab-c-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .graph-container {
      height: 420px;
      background: #fff;
      border: 1px solid var(--silver-border);
      border-radius: 12px;
      overflow: hidden;
    }
    .proof-block {
      background: #fff;
      border: 1px solid var(--silver-border);
      border-radius: 12px;
      padding: 14px;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      margin-top: 12px;
    }
    .proof-block .line { margin-bottom: 8px; }
    .proof-block .hint-text { color: var(--text-sub); font-size: 12px; margin-top: 10px; }
    .comparison-module { margin-top: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .comparison-col { background: #fff; border: 1px solid var(--silver-border); border-radius: 10px; padding: 14px; font-size: 13px; line-height: 1.55; }
    .comparison-col h4 { margin: 0 0 10px; font-size: 14px; color: var(--accent-main); }
    .comparison-col ul { margin: 0; padding-left: 18px; }
    .comparison-col li { margin-bottom: 6px; }
    .comparison-note { margin-top: 10px; font-size: 12px; color: var(--text-sub); font-style: italic; }
    .rules-card { background: #fff; border: 1px solid var(--accent-main); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .rules-card h3 { margin: 0 0 12px; font-size: 15px; color: var(--accent-main); }
    .rule-item { display: flex; gap: 10px; margin-bottom: 14px; font-size: 13px; line-height: 1.5; }
    .rule-item:last-child { margin-bottom: 0; }
    .rule-icon { flex-shrink: 0; font-size: 16px; }
    .rule-text { flex: 1; }
    .rule-en, .rule-zh { margin-bottom: 4px; font-weight: 500; color: var(--text-main); }
    .rule-en.off, .rule-zh.off { display: none; }
    .rules-footer { margin-top: 12px; padding-top: 10px; border-top: 1px dashed var(--silver-border); font-size: 12px; color: var(--text-sub); font-style: italic; }
    .node-detail {
      background: #fff;
      border: 1px dashed var(--silver-border);
      border-radius: 10px;
      padding: 12px;
      font-size: 12px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 180px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .btn-sm { margin-top: 8px; margin-right: 8px; padding: 8px 14px; font-size: 13px; }
    .err-msg { color: var(--bad); font-size: 13px; padding: 12px; }
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    .toast { background: #fff; border: 1px solid var(--accent-main); border-left: 4px solid var(--accent-main); border-radius: 12px; padding: 16px 20px; min-width: 320px; box-shadow: 0 4px 16px rgba(0,0,0,0.12); display: flex; justify-content: space-between; gap: 12px; animation: toastIn 0.25s ease; }
    .toast-body { flex: 1; }
    .toast-title { font-weight: 600; color: var(--accent-main); margin-bottom: 6px; font-size: 14px; }
    .toast-msg { font-size: 13px; color: var(--text-main); line-height: 1.5; }
    .toast-close { background: none; border: none; cursor: pointer; font-size: 18px; color: var(--text-sub); padding: 0 4px; line-height: 1; }
    .toast-close:hover { color: var(--text-main); }
    @keyframes toastIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    .ui-event-log { background: #fff; border: 1px dashed var(--silver-border); border-radius: 10px; padding: 12px; font-size: 12px; font-family: monospace; white-space: pre-wrap; max-height: 160px; overflow-y: auto; margin-top: 12px; color: var(--text-sub); }
    .conflict-history-card { background: #fff; border: 1px solid var(--accent-main); border-radius: 14px; padding: 16px; margin-top: 14px; }
    .conflict-history-card h4 { margin: 0 0 10px; font-size: 15px; color: var(--accent-main); display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
    .conflict-demo-btn { padding: 6px 12px; font-size: 12px; border-radius: 10px; border: 1px solid rgba(239,68,68,.35); background: var(--accent-soft); color: var(--accent-text); cursor: pointer; }
    .conflict-demo-btn:hover:not(:disabled) { filter: brightness(0.98); background: #fecaca; }
    .conflict-demo-btn:disabled { opacity: 0.7; cursor: not-allowed; }
    .conflict-history-card .proof-badge { background: var(--accent-main); color: #fecaca; font-size: 11px; padding: 4px 10px; border-radius: 999px; }
    .conflict-history-card ul { margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.6; color: var(--text-main); }
    .contact-badge { position: fixed; bottom: 12px; right: 12px; background: var(--accent-main); color: #fff; font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", sans-serif; font-size: 11px; padding: 5px 10px; border-radius: 6px; z-index: 9998; white-space: nowrap; box-shadow: 0 2px 6px rgba(239,68,68,0.3); border: 1px solid var(--accent-text); }
  </style>
</head>
<body>
<header>
  <div class="lang-toggle">
    <button class="lang-btn active" id="langEn" onclick="setLang('en')">EN</button>
    <button class="lang-btn" id="langZh" onclick="setLang('zh')">ä¸­æ–‡</button>
  </div>
  <h1 id="pageTitle">Decision Memory Â· User Research Agent</h1>
  <p id="pageSubtitle">B2B pre-sales diagnosis â†’ Research plan routing â†’ Actionable assets + validation metrics (no scraping)</p>
</header>

<div id="toastContainer" class="toast-container" style="display:none;"></div>

<main>
  <div class="tabs">
    <div class="tab active" id="tabA" onclick="switchTab('A')">A. B2B Diagnosis (Pre-sales)</div>
    <div class="tab" id="tabB" onclick="switchTab('B')">B. User Research Delivery (Qual + Quant)</div>
    <div class="tab" id="tabC" onclick="switchTab('C')">C. Decision Memory (Trace Graph)</div>
  </div>

  <div id="panelAB" class="grid">
    <section class="card">
      <h2 id="formTitle">Input (for Agent)</h2>

      <div class="row">
        <div>
          <label id="lblIndustry">ToB Customization</label>
          <select id="industry"></select>
        </div>
        <div>
          <label id="lblMarket">Target Market</label>
          <input id="market" placeholder="e.g. North America / Europe / SEA / Domestic"/>
        </div>
      </div>

      <label id="lblStage">Company Stage</label>
      <select id="stage"></select>

      <label id="lblGrowth">Growth Drivers (multi-select, ordered)</label>
      <textarea id="growth" placeholder="e.g. Marketing-Led Growth (MLG)&#10;Product-Led Growth (PLG)"></textarea>
      <div class="hint" id="hintGrowth">Use full names, not abbreviations only.</div>

      <label id="lblPositioning">Business Positioning</label>
      <select id="positioning"></select>

      <label id="lblGoal">Goal</label>
      <select id="goal"></select>

      <label id="lblProblem">Core Problem (with facts/data)</label>
      <textarea id="problem" placeholder="e.g. CAC up, CTR ok but add-to-cart low; users say 'can't tell difference' â€” high cart abandonment"></textarea>

      <label id="lblConstraints">Constraints (optional)</label>
      <textarea id="constraints" placeholder="e.g. results in 2 weeks; no minors; no raw audio storage; mid budget"></textarea>

      <button class="btn" onclick="runA()" id="btnRunA">Run A: Diagnose â†’ Research Plan</button>
      <button class="btn secondary" onclick="runB()" id="runBBtn" disabled>Run B: Interview Guide + Survey Draft</button>

      <div class="hint">
        <span id="hintTemplates">Templates:</span>
        <a href="../templates/Bç«¯å®¢æˆ·å”®å‰è¯Šæ–­é—®å·_æ——èˆ°ç‰ˆ.docx" download>Word</a> Â·
        <a href="../templates/ç ”ç©¶ç­–ç•¥è·¯ç”±è¡¨_æ——èˆ°ç‰ˆ.xlsx" download>Excel</a>
      </div>

      <div class="small" style="margin-top:10px;">
        <span id="apiBaseLabel">API Base:</span> <span id="apiBaseShow">https://api.userinsightagent.myrawzm0406.online</span>
        Â· <a href="#" onclick="setApiBase(); return false;" id="linkSetApi">Set API address</a>
      </div>
    </section>

    <section class="card">
      <h2 id="outTitle">Output (Actionable Deliverables)</h2>
      <div class="output" id="out">Waiting for inputâ€¦</div>
      <div style="margin-top:12px;">
        <span class="pill" id="pill1">Evidence-first</span>
        <span class="pill" id="pill2">Actionable + Verifiable</span>
        <span class="pill" id="pill3">Read-only templates</span>
      </div>
    </section>
  </div>

  <div id="panelC" class="tab-c-only">
    <div class="tab-c-grid">
      <section class="card">
        <h2 id="tabCOpTitle">Input / Actions</h2>
        <label>topic (optional)</label>
        <input id="traceTopic" placeholder="e.g. fintech"/>
        <label>stage (optional)</label>
        <input id="traceStage" placeholder="e.g. 1-10"/>
        <button class="btn btn-sm" onclick="loadTraceGraph()" id="btnLoadGraph">Load Trace Graph</button>
        <button class="btn btn-sm secondary" onclick="loadDecisionsSnapshots()" id="btnLoadDec">Load Decisions/Snapshots</button>
        <button class="btn btn-sm secondary" onclick="openApiDocs()" id="btnApiDocs">Open API Docs</button>
        <button class="btn btn-sm" style="border:1px solid var(--bad); color:var(--bad); background:#fff;" onclick="trigger400Demo()" id="btn400Demo">Trigger 400 Demo (Missing Citation)</button>
        <div class="hint" style="margin-top:12px;" id="hintTraceGraph">
          Trace Graph requires Decision Memory backend (uvicorn backend.api.main:app). API needs X-API-Key: admin123.
        </div>
      </section>

      <section class="card">
        <h2 id="tabCGraphTitle">Trace Graph & Memory Proof</h2>
        <div class="rules-card">
          <h3 id="rulesTitle">Decision Enforcement Rules</h3>
          <div class="rule-item">
            <span class="rule-icon">â›”</span>
            <div class="rule-text">
              <div class="rule-en" id="rule1En">Rule #1 â€” No Citation, No Decision. Any decision without historical citation is explicitly rejected by the system (HTTP 400).</div>
              <div class="rule-zh" id="rule1Zh">è§„åˆ™ä¸€ â€” æ— æ´å¼•ï¼Œä¸å†³ç­–ã€‚ä»»ä½•æœªæ´å¼•å†å²è¯æ®æˆ–å†³ç­–çš„åˆ¤æ–­ï¼Œéƒ½ä¼šè¢«ç³»ç»Ÿç›´æ¥æ‹’ç»ï¼ˆHTTP 400ï¼‰ã€‚</div>
            </div>
          </div>
          <div class="rule-item">
            <span class="rule-icon">ğŸ”’</span>
            <div class="rule-text">
              <div class="rule-en" id="rule2En">Rule #2 â€” Falsified conclusions cannot be reverted. If a requirement contradicts a previously falsified decision, it will be blocked.</div>
              <div class="rule-zh" id="rule2Zh">è§„åˆ™äºŒ â€” è¢«è¯ä¼ªçš„ç»“è®ºä¸å¯å›é€€ã€‚è‹¥æ–°éœ€æ±‚ä¸å·²è¢«è¯ä¼ªçš„å†å²å†³ç­–å†²çªï¼Œç³»ç»Ÿå°†é˜»æ­¢è¯¥éœ€æ±‚å›é€€ã€‚</div>
            </div>
          </div>
          <div class="rule-item">
            <span class="rule-icon">ğŸ“œ</span>
            <div class="rule-text">
              <div class="rule-en" id="rule3En">Rule #3 â€” Memory constrains future decisions. Past evidence and falsification actively constrain future decision space.</div>
              <div class="rule-zh" id="rule3Zh">è§„åˆ™ä¸‰ â€” è®°å¿†çº¦æŸæœªæ¥å†³ç­–ã€‚å†å²è¯æ®ä¸è¯ä¼ªç»“è®ºä¼šä¸»åŠ¨æ”¶ç¼©æœªæ¥å¯é€‰å†³ç­–ç©ºé—´ã€‚</div>
            </div>
          </div>
          <div class="rules-footer" id="rulesFooter"></div>
        </div>
        <div id="graphError" class="err-msg" style="display:none;"></div>
        <div id="graphWrapper" class="graph-container" style="display:none;"></div>
        <div id="graphPlaceholder" class="output" style="min-height:200px;">
          <span id="graphPlaceholderText">Click "Load Trace Graph" to fetch nodes/edges and render.</span>
        </div>
        <div class="conflict-history-card" id="conflictHistoryCard">
          <h4><span id="conflictHistoryTitle">Conflict History</span> <span class="proof-badge" id="conflictHistoryBadge">Memory-constrained</span><button class="conflict-demo-btn" id="btnConflictDemo" onclick="runConflictDemo()" data-i18n="btnConflictDemo">Run Conflict Demo</button></h4>
          <ul id="conflictHistoryList">
            <li>Round 2 falsified speed hypothesis</li>
            <li>Round 3 recall prevented rollback</li>
          </ul>
        </div>
        <div id="nodeDetail" class="node-detail" style="display:none;"></div>
        <div class="proof-block" style="margin-top:14px;">
          <div class="line"><strong id="proofRecallLabel">RecallHits Found:</strong> <span id="proofRecall">â€”</span></div>
          <div class="line"><strong id="proofConflictLabel">Conflict Reason:</strong> <span id="proofConflict">â€”</span></div>
          <div class="line"><strong id="proofRationaleLabel">Final Decision Rationale:</strong> <span id="proofRationale">â€”</span></div>
          <div class="hint-text" id="proofHint">If API cannot derive, copy from demo_outputs/demo.log.</div>
        </div>
        <div class="ui-event-log" id="uiEventLog">No events yet.</div>
        <div class="comparison-module">
          <h3 id="comparisonTitle" style="grid-column:1/-1; margin:0 0 8px; font-size:15px; color:var(--accent-main);">Why this decision requires memory</h3>
          <div class="comparison-col">
            <h4 id="comparisonWithTitle">With Memory Recall</h4>
            <ul id="comparisonWithList"></ul>
          </div>
          <div class="comparison-col">
            <h4 id="comparisonWithoutTitle">Without Memory Recall</h4>
            <ul id="comparisonWithoutList"></ul>
          </div>
          <p id="comparisonNote" class="comparison-note" style="grid-column:1/-1; margin:8px 0 0;"></p>
        </div>
      </section>
    </div>
  </div>
</main>

<footer>
  <div class="pill" id="footerPillA">A: Diagnosis</div>
  <div class="pill" id="footerPillB">B: Research</div>
  <div class="pill" id="footerPillC">C: Decision Memory</div>
  <p style="margin-top:10px;" id="footerNote">
    This demo shows how user research is agentified for conversion uplift. No external scraping.
  </p>
</footer>

<div class="contact-badge" id="contactBadge">Contact: myrawzm0406@163.com | WeChat 15301052620</div>

<script>
  const I18N = {
    en: {
      pageTitle: "User Research Agent Â· Conversation OS",
      pageSubtitle: "B2B pre-sales diagnosis â†’ Research plan routing â†’ Actionable assets + validation metrics (no scraping)",
      tabA: "A. B2B Diagnosis (Pre-sales)",
      tabB: "B. User Research Delivery (Qual + Quant)",
      tabC: "C. Decision Memory (Trace Graph)",
      formTitle: "Input (for Agent)",
      formTitleB: "Input (reuse A)",
      lblIndustry: "ToB Customization",
      lblMarket: "Target Market",
      lblStage: "Company Stage",
      lblGrowth: "Growth Drivers (multi-select, ordered)",
      lblPositioning: "Business Positioning",
      lblGoal: "Goal",
      lblProblem: "Core Problem (with facts/data)",
      lblConstraints: "Constraints (optional)",
      hintGrowth: "Use full names, not abbreviations only.",
      btnRunA: "Run A: Diagnose â†’ Research Plan",
      btnRunB: "Run B: Interview Guide + Survey Draft",
      hintTemplates: "Templates:",
      apiBaseLabel: "API Base:",
      linkSetApi: "Set API address",
      outTitle: "Output (Actionable Deliverables)",
      outWaiting: "Waiting for inputâ€¦",
      pill1: "Evidence-first",
      pill2: "Actionable + Verifiable",
      pill3: "Read-only templates",
      footerPillA: "A: Diagnosis",
      footerPillB: "B: Research",
      footerPillC: "C: Decision Memory",
      tabCOpTitle: "Input / Actions",
      btnLoadGraph: "Load Trace Graph",
      btnLoadDec: "Load Decisions/Snapshots",
      btnApiDocs: "Open API Docs",
      hintTraceGraph: "Trace Graph requires Decision Memory backend (uvicorn backend.api.main:app). API needs X-API-Key: admin123.",
      tabCGraphTitle: "Trace Graph & Memory Proof",
      graphPlaceholderText: "Click \"Load Trace Graph\" to fetch nodes/edges and render.",
      proofRecallLabel: "RecallHits Found:",
      proofConflictLabel: "Conflict Reason:",
      proofRationaleLabel: "Final Decision Rationale:",
      proofHint: "If API cannot derive, copy from demo_outputs/demo.log.",
      footerNote: "This demo shows how user research is agentified for conversion uplift. No external scraping.",
      loading: "Loadingâ€¦",
      runAProgress: "Runningâ€¦",
      runBProgress: "Generating B deliverablesâ€¦",
      errBackend: "Error:\n{msg}\n\nEnsure backend is running (python backend/app.py) and API address is correct.",
      errRunAFirst: "Please run A first.",
      errLoadGraph: "Load failed: {msg}\n\nCheck: 1) Backend running (uvicorn backend.api.main:app --port 8000); 2) API_BASE correct; 3) /api/v1/trace_graph exists.",
      proofCopyHint: "â€” (copy from demo.log)",
      alertDecLoaded: "Decisions/Traces loaded (see console). No dedicated endpoint; use trace_graph.",
      alertNoEndpoint: "Backend has no /api/v1/evidence/search or /api/v1/traces. Load Trace Graph first.",
      alertLoadFail: "Load failed: {msg}",
      comparisonTitle: "Why this decision requires memory",
      comparisonWithTitle: "With Memory Recall",
      comparisonWithItems: [
        "The agent recalls a previously falsified decision (Round 2).",
        "A contradiction is detected.",
        "The system rejects reverting the requirement.",
        "Decision consistency is preserved."
      ],
      comparisonWithoutTitle: "Without Memory Recall",
      comparisonWithoutItems: [
        "The agent only sees the latest interview.",
        "No contradiction is detected.",
        "The requirement would be reverted incorrectly.",
        "The organization repeats a known failure."
      ],
      comparisonNote: "This is not logging, this is decision constraint. The failure is not a model capability issueâ€”it is the absence of memory constraint.",
      rulesTitle: "Decision Enforcement Rules",
      rulesFooter: "This system enforces decisions, it does not suggest them.",
      btn400Demo: "Trigger 400 Demo (Missing Citation)",
      toastTitle400: "Decision Rejected (HTTP 400)",
      toastBody400: "Rule #1 triggered â€” No Citation, No Decision.",
      uiLogEmpty: "No events yet.",
      uiLogRejected400: "Decision rejected due to missing citations.",
      toastUnexpected: "Unexpected response",
      toastNetwork: "Network error",
      btnConflictDemo: "Run Conflict Demo",
      btnConflictDemoRunning: "Runningâ€¦",
      demoLogTrigger: "Triggering 400 decision demo (No Citation, No Decision)...",
      demoLogRefreshed: "Trace graph refreshed after demo.",
      toastDemoCompleted: "Demo completed",
      toastDemoCompletedBody: "Graph refreshed. Check Conflict History / Node Details.",
      toastUnexpectedResponse: "Unexpected response",
      logWarnExpected400: "Expected 400 but got HTTP {status}",
      toastNetworkError: "Network error",
      toastNetworkErrorBody: "Cannot reach backend. Check API_BASE.",
      logErrorNetwork: "Network error during 400 demo",
      toastRefreshFailed: "Refresh failed",
      logErrorRefresh: "Trace graph refresh failed: {msg}",
      demoLogClicked: "Run Conflict Demo clicked",
      toastDemoRunning: "Running demoâ€¦",
      logErrorMissing: "trigger400Demo handler missing",
      toastMissingHandler: "Missing demo handler",
      toastMissingHandlerBody: "trigger400Demo is not defined.",
      conflictHistoryTitle: "Conflict History",
      conflictHistoryBadge: "Memory-constrained",
      conflictBullet1: "Round 2 falsified speed hypothesis",
      conflictBullet2: "Round 3 recall prevented rollback",
      industryOptions: [
        { v: "tob_saas", en: "ToB SaaS", zh: "ToB SaaS" },
        { v: "toc_app", en: "ToC App (single-sided product: tools/games)", zh: "ToC App å•è¾¹äº§å“ï¼ˆå¦‚å·¥å…·/æ¸¸æˆï¼‰" },
        { v: "toc_platform", en: "ToC Platform (two-sided: e-commerce marketplace/content/social)", zh: "ToC åŒè¾¹å¹³å°ï¼ˆå¦‚ç”µå•†æ’®åˆäº¤æ˜“å¹³å°/å†…å®¹å¹³å°/ç¤¾äº¤å¹³å°ï¼‰" },
        { v: "agency", en: "Agency (MCN / talent management / influencer incubation)", zh: "Agencyï¼ˆå¦‚ MCN è¾¾äººè‰ºäººç»çºª / ç½‘çº¢å­µåŒ–ï¼‰" }
      ],
      stageOptions: [
        { v: "0-1", en: "0-1 (Infrastructure/Demo, validate feasibility)", zh: "0-1ï¼ˆåŸºå»º/åšDemoï¼Œå°½å¿«éªŒè¯å¯è¡Œæ€§ï¼‰" },
        { v: "1-10", en: "1-10 (Early product, find PMF)", zh: "1-10ï¼ˆå·²å‡ºDemo/æ—©æœŸäº§å“ï¼Œå¿«é€Ÿæ‰¾å®¢æˆ·éªŒè¯å•†ä¸šé—­ç¯ï¼‰" },
        { v: "10-100", en: "10-100 (Scale growth & efficiency)", zh: "10-100ï¼ˆå·²è·‘é€šäº¤æ˜“/æ”¶å…¥ï¼Œéœ€è§„æ¨¡åŒ–å¢é•¿ä¸æ•ˆç‡æå‡ï¼‰" },
        { v: "mature", en: "Mature (stable, pursue new growth)", zh: "æˆç†ŸæœŸï¼ˆäº¤æ˜“è§„æ¨¡/åˆ©æ¶¦ç¨³å®šï¼Œè¿½æ±‚æ›´é«˜æ•ˆç‡æˆ–æ–°å¢é•¿ç‚¹ï¼‰" },
        { v: "decline", en: "Decline (incubate new biz, second curve)", zh: "è¡°é¢“æœŸï¼ˆéœ€å­µåŒ–æ–°ä¸šåŠ¡ï¼Œæ¢ç´¢ä¸šåŠ¡å¢é•¿çš„ç¬¬äºŒæ›²çº¿ï¼‰" }
      ],
      positioningOptions: [
        { v: "new_biz", en: "New incubation: direction unclear, explore users & scenarios", zh: "æ–°å­µåŒ–/æ–°ä¸šåŠ¡ï¼šæ–¹å‘æœªå®Œå…¨æ¸…æ™°ï¼Œéœ€è¦æ¢ç´¢ç”¨æˆ·ä¸åœºæ™¯" },
        { v: "old_growth", en: "Old biz growth: new approach uncertain", zh: "æ—§ä¸šåŠ¡æ–°å¢é•¿ï¼šæœåŠ¡äºè€ä¸šåŠ¡å¢é•¿ï¼Œä½†æ–°æ–¹å¼æ•ˆæœä¸ç¡®å®š" },
        { v: "old_supply", en: "Mature supply, find new users & expression", zh: "æ—§ä¾›ç»™æ‰¾æ–°ç”¨æˆ·ï¼šä¾›ç»™ç›¸å¯¹æˆç†Ÿï¼Œéœ€è¦æ‰¾åˆ°æ–°ç›®æ ‡äººç¾¤ä¸æ–°è¡¨è¾¾" },
        { v: "validated", en: "Validated fit, scale replication", zh: "å·²éªŒè¯ä»·å€¼ï¼šå·²æœ‰æ˜ç¡®éœ€æ±‚/ä¾›ç»™åŒ¹é…ï¼Œéœ€è¦è§„æ¨¡åŒ–å¤åˆ¶ä¸æ‰©å¼ ï¼ˆåšäº†å¤§æ¦‚ç‡æœ‰æ•ˆï¼‰" },
        { v: "new_market", en: "New supply / new market", zh: "æ–°ä¾›ç»™/æ–°äº¤æ˜“åœºï¼šä¸ºä¸€ç±»ç”¨æˆ·æ–°éœ€æ±‚æ„å»ºæ–°çš„äº¤æ˜“åœº/æ–°äº§å“çº¿" }
      ],
      goalOptions: [
        { v: "first_order", en: "Increase first-order conversion", zh: "æå‡é¦–å•è´­ä¹°è½¬åŒ–ç‡" },
        { v: "repurchase", en: "Increase repurchase conversion", zh: "æå‡å¤è´­è½¬åŒ–ç‡" },
        { v: "refund", en: "Reduce refund/return rate", zh: "é™ä½é€€æ¬¾/é€€è´§ç‡" },
        { v: "lead_close", en: "Lead â†’ close conversion", zh: "æå‡çº¿ç´¢â†’æˆäº¤è½¬åŒ–ç‡" }
      ],
      marketPlaceholder: "e.g. North America / Europe / SEA / Domestic",
      growthPlaceholder: "e.g. Marketing-Led Growth (MLG)\nProduct-Led Growth (PLG)",
      problemPlaceholder: "e.g. CAC up, CTR ok but add-to-cart low; users say 'can't tell difference' â€” high cart abandonment",
      constraintsPlaceholder: "e.g. results in 2 weeks; no minors; no raw audio storage; mid budget",
      traceTopicPlaceholder: "e.g. fintech",
      traceStagePlaceholder: "e.g. 1-10",
      contactBadge: "Contact: myrawzm0406@163.com | WeChat 15301052620"
    },
    zh: {
      pageTitle: "ç”¨æˆ·ç ”ç©¶ Agent Â· å¯¹è¯ OS",
      pageSubtitle: "Bç«¯å”®å‰è¯Šæ–­ â†’ ç ”ç©¶æ–¹æ¡ˆè·¯ç”± â†’ å¯æ‰§è¡Œèµ„äº§ + éªŒè¯å£å¾„ï¼ˆä¸ä¾èµ–çˆ¬è™«ï¼‰",
      tabA: "A. Bç«¯å®¢æˆ·è¯Šæ–­ï¼ˆå”®å‰/ç«‹é¡¹ï¼‰",
      tabB: "B. ç”¨æˆ·ç ”ç©¶äº¤ä»˜ï¼ˆå®šæ€§+å®šé‡ï¼‰",
      tabC: "C. Decision Memory å¯è§†åŒ–ï¼ˆTrace Graphï¼‰",
      formTitle: "è¾“å…¥ï¼ˆç»™Agentï¼‰",
      formTitleB: "è¾“å…¥ï¼ˆæ²¿ç”¨Aæ®µä¿¡æ¯ï¼‰",
      lblIndustry: "ToB å®šåˆ¶ç±»å‹",
      lblMarket: "ç›®æ ‡å¸‚åœº",
      lblStage: "å…¬å¸é˜¶æ®µ",
      lblGrowth: "å¢é•¿é©±åŠ¨æ–¹å¼ï¼ˆå¯å¤šé€‰ï¼ŒæŒ‰ä¸»æ¬¡æ’åºï¼‰",
      lblPositioning: "ä¸šåŠ¡å®šä½",
      lblGoal: "æœ¬æ¬¡ç›®æ ‡",
      lblProblem: "æ ¸å¿ƒé—®é¢˜ï¼ˆå°½é‡åŒ…å«äº‹å®/æ•°æ®ï¼‰",
      lblConstraints: "çº¦æŸï¼ˆå¯é€‰ï¼‰",
      hintGrowth: "æç¤ºï¼šä¸è¦åªå†™ç¼©å†™ã€‚è¯·ç”¨ä¸­æ–‡æ„æ€ï¼ˆæ‹¬å·é‡Œå†™è‹±æ–‡å…¨ç§°ï¼‰ã€‚",
      btnRunA: "è¿è¡Œ Aï¼šè¯Šæ–­ â†’ ç ”ç©¶æ–¹æ¡ˆ",
      btnRunB: "è¿è¡Œ Bï¼šç”Ÿæˆè®¿è°ˆå¤§çº² + é—®å·è‰æ¡ˆ",
      hintTemplates: "æ¨¡æ¿ä¸‹è½½ï¼š",
      apiBaseLabel: "åç«¯é»˜è®¤åœ°å€ï¼š",
      linkSetApi: "è®¾ç½®APIåœ°å€",
      outTitle: "è¾“å‡ºï¼ˆå¯æ‰§è¡Œäº¤ä»˜ç‰©ï¼‰",
      outWaiting: "ç­‰å¾…è¾“å…¥â€¦",
      pill1: "è¯æ®ä¼˜å…ˆ",
      pill2: "å¯æ‰§è¡Œ + å¯éªŒè¯",
      pill3: "åªè¯»æ¨¡æ¿",
      footerPillA: "A: è¯Šæ–­",
      footerPillB: "B: ç ”ç©¶",
      footerPillC: "C: Decision Memory",
      tabCOpTitle: "è¾“å…¥ / æ“ä½œ",
      btnLoadGraph: "åŠ è½½ Trace Graph",
      btnLoadDec: "åŠ è½½æœ€æ–° Decisions/Snapshots",
      btnApiDocs: "æ‰“å¼€ API Docs",
      hintTraceGraph: "Trace Graph éœ€ Decision Memory åç«¯ï¼ˆuvicorn backend.api.main:appï¼‰ã€‚API éœ€ X-API-Key: admin123ã€‚",
      tabCGraphTitle: "Trace Graph ä¸ Memory Proof",
      graphPlaceholderText: "ç‚¹å‡»ã€ŒåŠ è½½ Trace Graphã€è·å– nodes/edges å¹¶æ¸²æŸ“å›¾è°±ã€‚",
      proofRecallLabel: "RecallHits Found:",
      proofConflictLabel: "Conflict Reason:",
      proofRationaleLabel: "Final Decision Rationale:",
      proofHint: "è‹¥ API æ— æ³•æ¨å¯¼ï¼Œè¯·ä» demo_outputs/demo.log å¤åˆ¶ä¸Šè¿°ä¸‰è¡Œå¡«å…¥å±•ç¤ºã€‚",
      footerNote: "æœ¬Demoç”¨äºå±•ç¤ºã€Œç”¨æˆ·ç ”ç©¶å¦‚ä½•è¢«AgentåŒ–å¹¶æœåŠ¡è½¬åŒ–æå‡é—­ç¯ã€ï¼Œä¸ä¾èµ–å¤–éƒ¨å¹³å°æŠ“å–æ•°æ®ã€‚",
      loading: "åŠ è½½ä¸­â€¦",
      runAProgress: "è¿è¡Œä¸­â€¦",
      runBProgress: "ç”ŸæˆBæ®µäº§ç‰©ä¸­â€¦",
      errBackend: "å‡ºé”™ï¼š\n{msg}\n\nè¯·ç¡®è®¤ï¼šåç«¯å·²å¯åŠ¨ï¼ˆpython backend/app.pyï¼‰ï¼Œä¸”APIåœ°å€æ­£ç¡®ã€‚",
      errRunAFirst: "è¯·å…ˆè¿è¡ŒAæ®µã€‚",
      errLoadGraph: "åŠ è½½å¤±è´¥ï¼š{msg}\n\nè¯·æ£€æŸ¥ï¼š1) åç«¯æ˜¯å¦å¯åŠ¨ï¼ˆuvicorn backend.api.main:app --port 8000ï¼‰ï¼›2) API_BASE æ˜¯å¦æ­£ç¡®ï¼›3) /api/v1/trace_graph æ˜¯å¦å­˜åœ¨ã€‚",
      proofCopyHint: "â€”ï¼ˆéœ€ä» demo.log å¤åˆ¶ï¼‰",
      alertDecLoaded: "Decisions/Traces å·²åŠ è½½ï¼ˆè§æ§åˆ¶å°ï¼‰ã€‚å½“å‰æ— ç‹¬ç«‹å±•ç¤ºç«¯ç‚¹ï¼Œå¯æŸ¥çœ‹ trace_graphã€‚",
      alertNoEndpoint: "åç«¯æš‚æ— å¯¹åº”ç«¯ç‚¹ã€‚è¯·å…ˆåŠ è½½ Trace Graphã€‚",
      alertLoadFail: "åŠ è½½å¤±è´¥ï¼š{msg}",
      comparisonTitle: "ä¸ºä»€ä¹ˆè¿™ä¸ªå†³ç­–å¿…é¡»ä¾èµ–è®°å¿†",
      comparisonWithTitle: "æœ‰è®°å¿†å›æº¯",
      comparisonWithItems: [
        "Agent å›æº¯åˆ° Round 2 ä¸­å·²è¢«è¯ä¼ªçš„å†³ç­–ã€‚",
        "ç³»ç»Ÿæ£€æµ‹åˆ°æ–°è®¿è°ˆä¸å†å²ç»“è®ºçš„å†²çªã€‚",
        "ç³»ç»Ÿæ‹’ç»éœ€æ±‚å›é€€ã€‚",
        "å†³ç­–æ¼”åŒ–ä¿æŒä¸€è‡´æ€§ã€‚"
      ],
      comparisonWithoutTitle: "å¦‚æœæ²¡æœ‰è®°å¿†",
      comparisonWithoutItems: [
        "Agent åªèƒ½çœ‹åˆ°æœ€æ–°è®¿è°ˆã€‚",
        "æ— æ³•è¯†åˆ«ä¸å†å²ç»“è®ºçš„å†²çªã€‚",
        "éœ€æ±‚ä¼šè¢«é”™è¯¯å›é€€ã€‚",
        "ç»„ç»‡ä¼šé‡å¤å·²ç»å¤±è´¥è¿‡çš„å†³ç­–ã€‚"
      ],
      comparisonNote: "è¿™ä¸æ˜¯æ—¥å¿—ï¼Œè¿™æ˜¯å†³ç­–çº¦æŸã€‚é”™è¯¯ä¸æ˜¯æ¨¡å‹èƒ½åŠ›é—®é¢˜ï¼Œè€Œæ˜¯ç¼ºå¤±è®°å¿†çº¦æŸã€‚",
      rulesTitle: "å†³ç­–å¼ºåˆ¶è§„åˆ™",
      rulesFooter: "æœ¬ç³»ç»Ÿå¼ºåˆ¶æ‰§è¡Œå†³ç­–ï¼Œè€Œéå»ºè®®å†³ç­–ã€‚",
      btn400Demo: "è§¦å‘ 400 æ¼”ç¤ºï¼ˆç¼ºå°‘æ´å¼•ï¼‰",
      toastTitle400: "å†³ç­–è¢«æ‹’ç»ï¼ˆHTTP 400ï¼‰",
      toastBody400: "è§¦å‘è§„åˆ™ä¸€ï¼šæ— æ´å¼•ï¼Œä¸å†³ç­–ã€‚",
      uiLogEmpty: "æš‚æ— äº‹ä»¶ã€‚",
      uiLogRejected400: "å†³ç­–å› ç¼ºå°‘æ´å¼•è¢«æ‹’ç»ã€‚",
      toastUnexpected: "éé¢„æœŸå“åº”",
      toastNetwork: "ç½‘ç»œé”™è¯¯",
      btnConflictDemo: "è¿è¡Œå†²çªæ¼”ç¤º",
      btnConflictDemoRunning: "è¿è¡Œä¸­â€¦",
      demoLogTrigger: "è§¦å‘ 400 å†³ç­–æ¼”ç¤ºï¼ˆæ— æ´å¼•ä¸å†³ç­–ï¼‰â€¦",
      demoLogRefreshed: "æ¼”ç¤ºå Trace Graph å·²åˆ·æ–°ã€‚",
      toastDemoCompleted: "æ¼”ç¤ºå®Œæˆ",
      toastDemoCompletedBody: "å›¾è°±å·²åˆ·æ–°ã€‚è¯·æŸ¥çœ‹ Conflict History / èŠ‚ç‚¹è¯¦æƒ…ã€‚",
      toastUnexpectedResponse: "éé¢„æœŸå“åº”",
      logWarnExpected400: "é¢„æœŸ 400 ä½†æ”¶åˆ° HTTP {status}",
      toastNetworkError: "ç½‘ç»œé”™è¯¯",
      toastNetworkErrorBody: "æ— æ³•è¿æ¥åç«¯ï¼Œè¯·æ£€æŸ¥ API_BASEã€‚",
      logErrorNetwork: "400 æ¼”ç¤ºæœŸé—´ç½‘ç»œé”™è¯¯",
      toastRefreshFailed: "åˆ·æ–°å¤±è´¥",
      logErrorRefresh: "Trace Graph åˆ·æ–°å¤±è´¥ï¼š{msg}",
      demoLogClicked: "è¿è¡Œå†²çªæ¼”ç¤ºå·²ç‚¹å‡»",
      toastDemoRunning: "æ­£åœ¨è¿è¡Œæ¼”ç¤ºâ€¦",
      logErrorMissing: "trigger400Demo å¤„ç†å™¨ç¼ºå¤±",
      toastMissingHandler: "æ¼”ç¤ºå¤„ç†å™¨ç¼ºå¤±",
      toastMissingHandlerBody: "trigger400Demo æœªå®šä¹‰ã€‚",
      conflictHistoryTitle: "å†²çªå†å²",
      conflictHistoryBadge: "Memory-constrained",
      conflictBullet1: "Round 2 è¯ä¼ªé€Ÿåº¦å‡è®¾",
      conflictBullet2: "Round 3 å›æº¯é˜»æ­¢å›é€€",
      industryOptions: [
        { v: "tob_customization", en: "ToB Customization", zh: "ToB å®šåˆ¶åŒ–" },
        { v: "tob_saas", en: "ToB SaaS", zh: "ToB SaaS" },
        { v: "toc_single", en: "ToC Single-sided App (e.g., tools/games)", zh: "ToC å•è¾¹äº§å“ï¼ˆå¦‚å·¥å…·/æ¸¸æˆï¼‰" },
        { v: "toc_platform", en: "ToC Two-sided Platform (e.g., marketplace/content/social)", zh: "ToC åŒè¾¹å¹³å°ï¼ˆå¦‚ç”µå•†æ’®åˆ/å†…å®¹å¹³å°/ç¤¾äº¤å¹³å°ï¼‰" },
        { v: "agency", en: "Agency (e.g., MCN/talent management/influencer incubator)", zh: "Agencyï¼ˆå¦‚MCN/è¾¾äººè‰ºäººç»çºª/ç½‘çº¢å­µåŒ–ï¼‰" }
      ],
      stageOptions: [
        { v: "0-1", en: "0-1 (Infrastructure/Demo, validate feasibility)", zh: "0-1ï¼ˆåŸºå»º/åšDemoï¼Œå°½å¿«éªŒè¯å¯è¡Œæ€§ï¼‰" },
        { v: "1-10", en: "1-10 (Early product, find PMF)", zh: "1-10ï¼ˆå·²å‡ºDemo/æ—©æœŸäº§å“ï¼Œå¿«é€Ÿæ‰¾å®¢æˆ·éªŒè¯å•†ä¸šé—­ç¯ï¼‰" },
        { v: "10-100", en: "10-100 (Scale growth & efficiency)", zh: "10-100ï¼ˆå·²è·‘é€šäº¤æ˜“/æ”¶å…¥ï¼Œéœ€è§„æ¨¡åŒ–å¢é•¿ä¸æ•ˆç‡æå‡ï¼‰" },
        { v: "mature", en: "Mature (stable, pursue new growth)", zh: "æˆç†ŸæœŸï¼ˆäº¤æ˜“è§„æ¨¡/åˆ©æ¶¦ç¨³å®šï¼Œè¿½æ±‚æ›´é«˜æ•ˆç‡æˆ–æ–°å¢é•¿ç‚¹ï¼‰" },
        { v: "decline", en: "Decline (incubate new biz, second curve)", zh: "è¡°é¢“æœŸï¼ˆéœ€å­µåŒ–æ–°ä¸šåŠ¡ï¼Œæ¢ç´¢ä¸šåŠ¡å¢é•¿çš„ç¬¬äºŒæ›²çº¿ï¼‰" }
      ],
      positioningOptions: [
        { v: "new_biz", en: "New incubation: direction unclear, explore users & scenarios", zh: "æ–°å­µåŒ–/æ–°ä¸šåŠ¡ï¼šæ–¹å‘æœªå®Œå…¨æ¸…æ™°ï¼Œéœ€è¦æ¢ç´¢ç”¨æˆ·ä¸åœºæ™¯" },
        { v: "old_growth", en: "Old biz growth: new approach uncertain", zh: "æ—§ä¸šåŠ¡æ–°å¢é•¿ï¼šæœåŠ¡äºè€ä¸šåŠ¡å¢é•¿ï¼Œä½†æ–°æ–¹å¼æ•ˆæœä¸ç¡®å®š" },
        { v: "old_supply", en: "Mature supply, find new users & expression", zh: "æ—§ä¾›ç»™æ‰¾æ–°ç”¨æˆ·ï¼šä¾›ç»™ç›¸å¯¹æˆç†Ÿï¼Œéœ€è¦æ‰¾åˆ°æ–°ç›®æ ‡äººç¾¤ä¸æ–°è¡¨è¾¾" },
        { v: "validated", en: "Validated fit, scale replication", zh: "å·²éªŒè¯ä»·å€¼ï¼šå·²æœ‰æ˜ç¡®éœ€æ±‚/ä¾›ç»™åŒ¹é…ï¼Œéœ€è¦è§„æ¨¡åŒ–å¤åˆ¶ä¸æ‰©å¼ ï¼ˆåšäº†å¤§æ¦‚ç‡æœ‰æ•ˆï¼‰" },
        { v: "new_market", en: "New supply / new market", zh: "æ–°ä¾›ç»™/æ–°äº¤æ˜“åœºï¼šä¸ºä¸€ç±»ç”¨æˆ·æ–°éœ€æ±‚æ„å»ºæ–°çš„äº¤æ˜“åœº/æ–°äº§å“çº¿" }
      ],
      goalOptions: [
        { v: "first_order", en: "Increase first-order conversion", zh: "æå‡é¦–å•è´­ä¹°è½¬åŒ–ç‡" },
        { v: "repurchase", en: "Increase repurchase conversion", zh: "æå‡å¤è´­è½¬åŒ–ç‡" },
        { v: "refund", en: "Reduce refund/return rate", zh: "é™ä½é€€æ¬¾/é€€è´§ç‡" },
        { v: "lead_close", en: "Lead â†’ close conversion", zh: "æå‡çº¿ç´¢â†’æˆäº¤è½¬åŒ–ç‡" }
      ],
      marketPlaceholder: "ä¾‹å¦‚ï¼šåŒ—ç¾ / æ¬§æ´² / ä¸œå—äºš / å›½å†…",
      growthPlaceholder: "ä¾‹å¦‚ï¼šè¥é”€é©±åŠ¨å¢é•¿ï¼ˆMarketing-Led Growth, MLGï¼‰\näº§å“é©±åŠ¨å¢é•¿ï¼ˆProduct-Led Growth, PLGï¼‰",
      problemPlaceholder: "ä¾‹å¦‚ï¼šä¹°é‡æˆæœ¬ä¸Šå‡ï¼Œç‚¹å‡»ä¸å·®ä½†åŠ è´­ç‡ä½ï¼›ç”¨æˆ·ç»å¸¸è¯´'çœ‹ä¸æ‡‚å·®åˆ«/ä¸æ•¢ä¹°'ï¼Œå¼ƒè´­ç‡é«˜ã€‚",
      constraintsPlaceholder: "ä¾‹å¦‚ï¼šä¸¤å‘¨å†…è¦å‡ºç»“æœï¼›ä¸èƒ½è§¦è¾¾æœªæˆå¹´äººï¼›ä¸èƒ½å­˜å‚¨åŸå§‹éŸ³é¢‘ï¼›é¢„ç®—ä¸­ç­‰ã€‚",
      traceTopicPlaceholder: "ä¾‹å¦‚ï¼šfintech",
      traceStagePlaceholder: "ä¾‹å¦‚ï¼š1-10",
      contactBadge: "è”ç³»ä½œè€… myrawzm0406@163.com å¾®ä¿¡ 15301052620"
    }
  };

  let LANG = localStorage.getItem("ui_lang") || "en";
  let CURRENT_DIAGNOSE = null;
  let TAB = 'A';
  function getDefaultApiBase(){
    try {
      const stored = localStorage.getItem("API_BASE");
      if (stored) return stored;
      const o = (typeof window !== "undefined" && window.location && window.location.origin) ? window.location.origin : "";
      if (!o || /^https?:\/\/(localhost|127\.0\.0\.1)(:\d+)?$/i.test(o)) return "http://127.0.0.1:8000";
      return "https://api.userinsightagent.myrawzm0406.online";
    } catch(e) { return "https://api.userinsightagent.myrawzm0406.online"; }
  }
  let API_BASE = getDefaultApiBase();
  const API_KEY = "admin123";
  let visNetworkInstance = null;
  let lastTraceGraphData = null;

  function t(key) {
    const dict = I18N[LANG];
    if (dict && dict[key] !== undefined) return dict[key];
    return I18N.en[key] !== undefined ? I18N.en[key] : key;
  }
  function renderLang() { applyLang(); }

  function setLang(lang) {
    LANG = lang;
    localStorage.setItem("ui_lang", lang);
    document.getElementById("langEn").classList.toggle("active", lang === "en");
    document.getElementById("langZh").classList.toggle("active", lang === "zh");
    applyLang();
  }

  function applyLang() {
    const t = I18N[LANG];
    document.getElementById("pageTitle").textContent = t.pageTitle;
    document.getElementById("pageSubtitle").textContent = t.pageSubtitle;
    document.getElementById("tabA").textContent = t.tabA;
    document.getElementById("tabB").textContent = t.tabB;
    document.getElementById("tabC").textContent = t.tabC;
    document.getElementById("formTitle").textContent = TAB === 'A' ? t.formTitle : (TAB === 'B' ? t.formTitleB : t.formTitle);
    document.getElementById("lblIndustry").textContent = t.lblIndustry;
    const industrySel = document.getElementById("industry");
    const industryOpts = t.industryOptions || [];
    industrySel.innerHTML = industryOpts.map(o => `<option value="${o.v}">${o[LANG] || o.en}</option>`).join("");
    document.getElementById("lblMarket").textContent = t.lblMarket;
    document.getElementById("market").placeholder = t.marketPlaceholder || "";
    document.getElementById("lblStage").textContent = t.lblStage;
    const stageSel = document.getElementById("stage");
    const stageOpts = t.stageOptions || [];
    stageSel.innerHTML = stageOpts.map(o => `<option value="${o.v}">${o[LANG] || o.en}</option>`).join("");
    document.getElementById("lblGrowth").textContent = t.lblGrowth;
    document.getElementById("growth").placeholder = t.growthPlaceholder || "";
    document.getElementById("lblPositioning").textContent = t.lblPositioning;
    const posSel = document.getElementById("positioning");
    const posOpts = t.positioningOptions || [];
    posSel.innerHTML = posOpts.map(o => `<option value="${o.v}">${o[LANG] || o.en}</option>`).join("");
    document.getElementById("lblGoal").textContent = t.lblGoal;
    const goalSel = document.getElementById("goal");
    const goalOpts = t.goalOptions || [];
    goalSel.innerHTML = goalOpts.map(o => `<option value="${o.v}">${o[LANG] || o.en}</option>`).join("");
    document.getElementById("lblProblem").textContent = t.lblProblem;
    document.getElementById("problem").placeholder = t.problemPlaceholder || "";
    document.getElementById("lblConstraints").textContent = t.lblConstraints;
    document.getElementById("constraints").placeholder = t.constraintsPlaceholder || "";
    document.getElementById("hintGrowth").textContent = t.hintGrowth;
    document.getElementById("btnRunA").textContent = t.btnRunA;
    document.getElementById("runBBtn").textContent = t.btnRunB;
    document.getElementById("hintTemplates").textContent = t.hintTemplates;
    document.getElementById("apiBaseLabel").textContent = t.apiBaseLabel;
    document.getElementById("linkSetApi").textContent = t.linkSetApi;
    document.getElementById("outTitle").textContent = t.outTitle;
    const el = document.getElementById("pill1"); if (el) el.textContent = t.pill1;
    const el2 = document.getElementById("pill2"); if (el2) el2.textContent = t.pill2;
    const el3 = document.getElementById("pill3"); if (el3) el3.textContent = t.pill3;
    const fpA = document.getElementById("footerPillA"); if (fpA) fpA.textContent = t.footerPillA;
    const fpB = document.getElementById("footerPillB"); if (fpB) fpB.textContent = t.footerPillB;
    const fpC = document.getElementById("footerPillC"); if (fpC) fpC.textContent = t.footerPillC;
    const contactBadgeEl = document.getElementById("contactBadge"); if (contactBadgeEl) contactBadgeEl.textContent = t.contactBadge;
    document.getElementById("tabCOpTitle").textContent = t.tabCOpTitle;
    document.getElementById("btnLoadGraph").textContent = t.btnLoadGraph;
    document.getElementById("btnLoadDec").textContent = t.btnLoadDec;
    document.getElementById("btnApiDocs").textContent = t.btnApiDocs;
    document.getElementById("hintTraceGraph").textContent = t.hintTraceGraph;
    document.getElementById("traceTopic").placeholder = t.traceTopicPlaceholder || "";
    document.getElementById("traceStage").placeholder = t.traceStagePlaceholder || "";
    document.getElementById("tabCGraphTitle").textContent = t.tabCGraphTitle;
    document.getElementById("graphPlaceholderText").textContent = t.graphPlaceholderText;
    document.getElementById("proofRecallLabel").textContent = t.proofRecallLabel;
    document.getElementById("proofConflictLabel").textContent = t.proofConflictLabel;
    document.getElementById("proofRationaleLabel").textContent = t.proofRationaleLabel;
    document.getElementById("proofHint").textContent = t.proofHint;
    document.getElementById("footerNote").textContent = t.footerNote;
    document.getElementById("comparisonTitle").textContent = t.comparisonTitle;
    document.getElementById("comparisonWithTitle").textContent = t.comparisonWithTitle;
    document.getElementById("comparisonWithoutTitle").textContent = t.comparisonWithoutTitle;
    document.getElementById("comparisonNote").textContent = t.comparisonNote;
    document.getElementById("rulesTitle").textContent = t.rulesTitle;
    document.getElementById("rulesFooter").textContent = t.rulesFooter;
    document.querySelectorAll(".rule-en").forEach(el => { el.classList.toggle("off", LANG !== "en"); });
    document.querySelectorAll(".rule-zh").forEach(el => { el.classList.toggle("off", LANG !== "zh"); });
    document.getElementById("btn400Demo").textContent = t.btn400Demo;
    const btnConflictDemo = document.getElementById("btnConflictDemo");
    if (btnConflictDemo && !btnConflictDemo.disabled) btnConflictDemo.textContent = t.btnConflictDemo;
    document.getElementById("conflictHistoryTitle").textContent = t.conflictHistoryTitle;
    document.getElementById("conflictHistoryBadge").textContent = t.conflictHistoryBadge;
    if (lastTraceGraphData) renderConflictHistory(lastTraceGraphData, null);
    if (document.getElementById("uiEventLog").textContent === "No events yet." || document.getElementById("uiEventLog").textContent === "æš‚æ— äº‹ä»¶ã€‚") {
      document.getElementById("uiEventLog").textContent = t.uiLogEmpty;
    }
    const withList = document.getElementById("comparisonWithList");
    withList.innerHTML = (t.comparisonWithItems || []).map(s => `<li>${s}</li>`).join("");
    const withoutList = document.getElementById("comparisonWithoutList");
    withoutList.innerHTML = (t.comparisonWithoutItems || []).map(s => `<li>${s}</li>`).join("");
    if (document.getElementById("out").textContent === "Waiting for inputâ€¦" || document.getElementById("out").textContent === "ç­‰å¾…è¾“å…¥â€¦") {
      document.getElementById("out").textContent = t.outWaiting;
    }
  }

  document.getElementById("apiBaseShow").innerText = API_BASE;
  setLang(LANG);

  function switchTab(t){
    TAB = t;
    document.getElementById("tabA").classList.toggle("active", t==='A');
    document.getElementById("tabB").classList.toggle("active", t==='B');
    document.getElementById("tabC").classList.toggle("active", t==='C');
    document.getElementById("panelAB").style.display = (t==='A' || t==='B') ? 'grid' : 'none';
    document.getElementById("panelC").classList.toggle("visible", t==='C');
    const t2 = I18N[LANG];
    document.getElementById("formTitle").textContent = (t==='A') ? t2.formTitle : (t==='B') ? t2.formTitleB : t2.formTitle;
  }

  function setApiBase(){
    const v = prompt(LANG === 'zh' ? "è¯·è¾“å…¥åç«¯APIåœ°å€ï¼ˆä¾‹å¦‚ http://127.0.0.1:8000 ï¼‰" : "Enter API base (e.g. http://127.0.0.1:8000)", API_BASE);
    if(!v) return;
    API_BASE = v.replace(/\/+$/,'');
    localStorage.setItem("API_BASE", API_BASE);
    document.getElementById("apiBaseShow").innerText = API_BASE;
  }

  function readInput(){
    const growthText = document.getElementById('growth').value || "";
    const growthList = growthText.split("\n").map(x=>x.trim()).filter(Boolean);
    return {
      industry: (()=>{ const s=document.getElementById('industry'); return s.value ? (s.options[s.selectedIndex]?.text || s.value) : (LANG === 'zh' ? "æœªå¡«å†™" : "N/A"); })(),
      market: document.getElementById('market').value || (LANG === 'zh' ? "æœªå¡«å†™" : "N/A"),
      company_stage: document.getElementById('stage').value,
      growth_driver: growthList.length ? growthList : [LANG === 'zh' ? "è¥é”€é©±åŠ¨å¢é•¿ï¼ˆMarketing-Led Growth, MLGï¼‰" : "Marketing-Led Growth (MLG)"],
      biz_positioning: document.getElementById('positioning').value,
      core_problem: document.getElementById('problem').value,
      constraints: document.getElementById('constraints').value,
      target_goal: document.getElementById('goal').value
    };
  }

  async function post(path, body){
    const res = await fetch(`${API_BASE}${path}`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    if(!res.ok){
      const t = await res.text();
      throw new Error(`HTTP ${res.status}: ${t}`);
    }
    return await res.json();
  }

  function pretty(obj){ return JSON.stringify(obj, null, 2); }

  async function runA(){
    const payload = readInput();
    const out = document.getElementById('out');
    const t = I18N[LANG];
    out.innerText = t.runAProgress;
    try{
      const diag = await post("/api/diagnose", payload);
      CURRENT_DIAGNOSE = diag;
      const plan = await post("/api/research_plan", { diagnose: diag, timeline: "2-4å‘¨", budget_level: "ä¸­" });

      let txt = "";
      if (LANG === 'zh') {
        txt += "ã€Aæ®µï¼šå”®å‰è¯Šæ–­ç»“æœã€‘\n";
        txt += `- å…¬å¸é˜¶æ®µï¼š${diag.stage}\n`;
        txt += `- å¢é•¿é©±åŠ¨ï¼š${(diag.growth_driver||[]).join(" / ")}\n`;
        txt += `- ä¸šåŠ¡å®šä½ï¼š${diag.biz_positioning}\n`;
        txt += `- ç›®æ ‡ï¼š${diag.goal}\n`;
        txt += `- é—®é¢˜ç±»å‹ï¼š${(diag.problem_types||[]).join(" / ")}\n`;
        txt += `- ç´§æ€¥åº¦ï¼š${diag.urgency}ï¼›å¯æ§æ€§ï¼š${diag.controllability}\n\n`;
        txt += "ã€æ¨èè·¯çº¿ã€‘\n";
        (diag.recommended_route||[]).forEach(x=>{ txt += `- ${x}\n`; });
        txt += "\nã€ç ”ç©¶æ–¹æ¡ˆï¼ˆæ‘˜è¦ï¼‰ã€‘\n";
        txt += `- å®šæ€§æ ·æœ¬å»ºè®®ï¼š${plan.qualitative.recommended_n}\n`;
        txt += `- å®šé‡æ ·æœ¬å»ºè®®ï¼š${plan.quantitative.recommended_n}\n`;
        txt += `- äº¤ä»˜ç‰©é‡ç‚¹ï¼š\n`;
        (plan.deliverables||[]).forEach(x=>{ txt += `  Â· ${x}\n`; });
        txt += "\nã€éªŒè¯æŒ‡æ ‡å£å¾„ï¼ˆç¤ºä¾‹ï¼‰ã€‘\n";
        (plan.validation_metrics||[]).forEach(m=>{
          txt += `- ${m.metric}ï¼š${m.definition}${m.note?("ï¼ˆ"+m.note+"ï¼‰"):""}\n`;
        });
        txt += "\nã€ä¸‹ä¸€æ­¥ã€‘\n";
        txt += "- ç‚¹ã€Œè¿è¡ŒBã€ç”Ÿæˆï¼šå”®å‰æé—®æ¸…å•ã€45åˆ†é’Ÿè®¿è°ˆå¤§çº²ã€å®šé‡é—®å·è‰æ¡ˆä¸æ•°æ®è´¨é‡è§„åˆ™ã€‚\n";
      } else {
        txt += "ã€A: Diagnosis Resultã€‘\n";
        txt += `- Stage: ${diag.stage}\n`;
        txt += `- Growth drivers: ${(diag.growth_driver||[]).join(" / ")}\n`;
        txt += `- Positioning: ${diag.biz_positioning}\n`;
        txt += `- Goal: ${diag.goal}\n`;
        txt += `- Problem types: ${(diag.problem_types||[]).join(" / ")}\n`;
        txt += `- Urgency: ${diag.urgency}; Controllability: ${diag.controllability}\n\n`;
        txt += "ã€Recommended Routeã€‘\n";
        (diag.recommended_route||[]).forEach(x=>{ txt += `- ${x}\n`; });
        txt += "\nã€Research Plan (Summary)ã€‘\n";
        txt += `- Qual sample: ${plan.qualitative.recommended_n}\n`;
        txt += `- Quant sample: ${plan.quantitative.recommended_n}\n`;
        txt += `- Deliverables:\n`;
        (plan.deliverables||[]).forEach(x=>{ txt += `  Â· ${x}\n`; });
        txt += "\nã€Validation Metricsã€‘\n";
        (plan.validation_metrics||[]).forEach(m=>{
          txt += `- ${m.metric}: ${m.definition}${m.note?(" ("+m.note+")"):""}\n`;
        });
        txt += "\nã€Nextã€‘\n";
        txt += "- Click \"Run B\" for interview guide, survey draft, data quality rules.\n";
      }

      out.innerText = txt;
      document.getElementById("runBBtn").disabled = false;
      switchTab('A');
    }catch(e){
      out.innerText = t.errBackend.replace("{msg}", e.message);
      document.getElementById("runBBtn").disabled = true;
    }
  }

  async function runB(){
    if(!CURRENT_DIAGNOSE){
      alert(I18N[LANG].errRunAFirst);
      return;
    }
    const payload = readInput();
    const out = document.getElementById('out');
    const t = I18N[LANG];
    out.innerText = t.runBProgress;
    try{
      const b2b = await post("/api/b2b_questions", payload);
      const qual = await post("/api/qual_guide", payload);
      const quant = await post("/api/quant_survey", payload);

      let txt = "";
      if (LANG === 'zh') {
        txt += "ã€Bæ®µï¼šå¯ç›´æ¥äº¤ä»˜çš„ç ”ç©¶èµ„äº§ï¼ˆè‰æ¡ˆï¼‰ã€‘\n\n";
        txt += "1) å”®å‰æé—®æ¸…å•ï¼ˆç»™é”€å”®/å”®å‰ï¼‰\n";
        (b2b.questions||[]).forEach((q)=>{ txt += `- [${q.section}] ${q.q}\n`; });
        txt += "\n2) 45åˆ†é’Ÿå®šæ€§è®¿è°ˆå¤§çº²ï¼ˆåŠç»“æ„åŒ–ï¼‰\n";
        txt += `- æ—¶é•¿ï¼š${qual.qual_guide.duration_minutes}åˆ†é’Ÿ\n`;
        txt += "- åŸåˆ™ï¼š\n";
        (qual.qual_guide.principles||[]).forEach(p=> txt += `  Â· ${p}\n`);
        txt += "\n- ç»“æ„ï¼š\n";
        (qual.qual_guide.sections||[]).forEach(sec=>{
          txt += `  Â· ${sec.t}\n`;
          (sec.prompts||[]).forEach(p=> txt += `     - ${p}\n`);
        });
        txt += "\n3) å®šé‡é—®å·è‰æ¡ˆï¼ˆæ¨¡å—åŒ–ï¼‰\n";
        (quant.quant_survey.modules||[]).forEach(mod=>{
          txt += `- æ¨¡å—ï¼š${mod.name}\n`;
          if(mod.note) txt += `  è¯´æ˜ï¼š${mod.note}\n`;
          (mod.questions||[]).forEach(q=>{ txt += `  Â· ${q.id}ï¼ˆ${q.type}ï¼‰${q.q}\n`; });
        });
        txt += "\n4) æ•°æ®è´¨é‡ä¸æ¸…æ´—è§„åˆ™\n";
        const dq = quant.quant_survey.data_quality || {};
        txt += `- é€Ÿåº¦å¼‚å¸¸è§„åˆ™ï¼š${dq.speeding_rule || "â€”"}\n`;
        txt += `- ç›´çº¿ä½œç­”è§„åˆ™ï¼š${dq.straightlining_rule || "â€”"}\n`;
        txt += `- çŸ›ç›¾æ£€æµ‹è§„åˆ™ï¼š${dq.contradiction_rule || "â€”"}\n`;
        (dq.attention_checks||[]).forEach(x=> txt += `- æ³¨æ„åŠ›é¢˜ï¼š${x}\n`);
        txt += "\n5) åªè¯»æ•°æ®æŸ¥è¯¢æ¨¡æ¿\n";
      } else {
        txt += "ã€B: Actionable Research Assets (Draft)ã€‘\n\n";
        txt += "1) Pre-sales Question List\n";
        (b2b.questions||[]).forEach((q)=>{ txt += `- [${q.section}] ${q.q}\n`; });
        txt += "\n2) 45-min Qualitative Interview Guide\n";
        txt += `- Duration: ${qual.qual_guide.duration_minutes} min\n`;
        txt += "- Principles:\n";
        (qual.qual_guide.principles||[]).forEach(p=> txt += `  Â· ${p}\n`);
        txt += "\n- Structure:\n";
        (qual.qual_guide.sections||[]).forEach(sec=>{
          txt += `  Â· ${sec.t}\n`;
          (sec.prompts||[]).forEach(p=> txt += `     - ${p}\n`);
        });
        txt += "\n3) Quantitative Survey Draft (Modular)\n";
        (quant.quant_survey.modules||[]).forEach(mod=>{
          txt += `- Module: ${mod.name}\n`;
          if(mod.note) txt += `  Note: ${mod.note}\n`;
          (mod.questions||[]).forEach(q=>{ txt += `  Â· ${q.id} (${q.type}) ${q.q}\n`; });
        });
        txt += "\n4) Data Quality & Cleaning Rules\n";
        const dq = quant.quant_survey.data_quality || {};
        txt += `- Speeding: ${dq.speeding_rule || "â€”"}\n`;
        txt += `- Straightlining: ${dq.straightlining_rule || "â€”"}\n`;
        txt += `- Contradiction: ${dq.contradiction_rule || "â€”"}\n`;
        (dq.attention_checks||[]).forEach(x=> txt += `- Attention: ${x}\n`);
        txt += "\n5) Read-only Query Templates\n";
      }
      const sql = await fetch(`${API_BASE}/api/sql_templates`).then(r=>r.json());
      (sql.templates||[]).forEach(tm=>{ txt += `- ${tm.name}: ${tm.description}\n`; });

      out.innerText = txt;
      switchTab('B');
    }catch(e){
      out.innerText = "Error: " + e.message;
    }
  }

  function getTraceGraphUrl(){
    const topic = (document.getElementById('traceTopic').value || '').trim();
    const stage = (document.getElementById('traceStage').value || '').trim();
    let url = `${API_BASE}/api/v1/trace_graph`;
    const params = [];
    if(topic) params.push('topic='+encodeURIComponent(topic));
    if(stage) params.push('stage='+encodeURIComponent(stage));
    if(params.length) url += '?' + params.join('&');
    return url;
  }

  async function loadTraceGraph(){
    const errEl = document.getElementById('graphError');
    const wrapper = document.getElementById('graphWrapper');
    const placeholder = document.getElementById('graphPlaceholder');
    const t = I18N[LANG];
    errEl.style.display = 'none';
    errEl.textContent = '';
    placeholder.style.display = 'block';
    wrapper.style.display = 'none';
    document.getElementById("graphPlaceholderText").textContent = t.loading;

    try {
      const url = getTraceGraphUrl();
      const res = await fetch(url, { headers: { "X-API-Key": API_KEY } });
      if(!res.ok){
        const text = await res.text();
        throw new Error(`HTTP ${res.status}: ${text || res.statusText}`);
      }
      const data = await res.json();
      lastTraceGraphData = data;
      renderGraph(data);
      updateProofFromGraph(data);
      renderConflictHistory(data, null);
      placeholder.style.display = 'none';
      wrapper.style.display = 'block';
    } catch(e) {
      placeholder.style.display = 'block';
      document.getElementById("graphPlaceholderText").textContent = t.graphPlaceholderText;
      errEl.style.display = 'block';
      errEl.textContent = t.errLoadGraph.replace("{msg}", e.message);
    }
  }

  function nodeColorByType(type){
    const map = {
      Evidence:   { background: '#eaf0ff', border: '#2f6bff' },
      Decision:  { background: '#c7d7fe', border: '#1d4ed8' },
      Requirement: { background: '#93c5fd', border: '#1e40af' },
      Outcome:   { background: '#d1d5db', border: '#6b7280' }
    };
    return map[type] || { background: '#f3f4f6', border: '#9ca3af' };
  }

  function nodeShapeByType(type){
    if(type === 'Evidence') return 'box';
    if(type === 'Decision') return 'diamond';
    if(type === 'Requirement') return 'ellipse';
    if(type === 'Outcome') return 'triangle';
    return 'ellipse';
  }

  function edgeLabelByType(type){
    const map = { cites: 'cites', derived_from: 'derived_from', falsifies: 'falsifies', supports: 'supports', updates: 'updates' };
    return map[type] || 'cites';
  }

  function renderGraph(data){
    const wrapper = document.getElementById('graphWrapper');
    wrapper.innerHTML = '';
    const container = document.createElement('div');
    container.style.width = '100%';
    container.style.height = '100%';
    wrapper.appendChild(container);

    const nodes = (data.nodes || []).map(n => {
      const c = nodeColorByType(n.label || n.type);
      const shape = nodeShapeByType(n.label || n.type);
      const label = (n.summary || n.label || n.id || '').substring(0, 40) + ((n.summary||'').length > 40 ? 'â€¦' : '');
      return {
        id: n.id,
        label: label,
        shape: shape,
        color: { background: c.background, border: c.border },
        title: n.summary || n.label || n.id,
        raw: n
      };
    });

    const edges = (data.edges || []).map(e => ({
      from: e.source,
      to: e.target,
      label: edgeLabelByType(e.type || 'cites'),
      arrows: 'to'
    }));

    const visNodes = new vis.DataSet(nodes.map(n => ({ id: n.id, label: n.label, shape: n.shape, color: n.color, title: n.title })));
    const visEdges = new vis.DataSet(edges);
    const visData = { nodes: visNodes, edges: visEdges };
    const options = {
      nodes: { font: { size: 12 } },
      edges: { font: { size: 10, align: 'middle' } },
      physics: { enabled: true, barnesHut: { gravitationalConstant: -2000, springLength: 120 } }
    };

    const network = new vis.Network(container, visData, options);
    visNetworkInstance = network;
    const nodeMap = {};
    nodes.forEach(n => { nodeMap[n.id] = n; });

    network.on('click', function(params) {
      if (params.nodes.length === 0) {
        document.getElementById('nodeDetail').style.display = 'none';
        return;
      }
      const id = params.nodes[0];
      const node = nodeMap[id] || (data.nodes || []).find(n => n.id === id);
      const raw = node && node.raw ? node.raw : (data.nodes || []).find(n => n.id === id) || { id };
      renderNodeDetails(raw);
    });
  }

  function renderNodeDetails(node){
    const el = document.getElementById('nodeDetail');
    el.style.display = 'block';
    el.textContent = pretty(node);
  }

  function renderConflictHistory(graphJson, maybeNodeDetails){
    const t = I18N[LANG];
    const listEl = document.getElementById("conflictHistoryList");
    const nodes = graphJson && graphJson.nodes ? graphJson.nodes : [];
    const edges = graphJson && graphJson.edges ? graphJson.edges : [];
    const DEFAULT_BULLET1 = t.conflictBullet1;
    const DEFAULT_BULLET2 = t.conflictBullet2;
    let bullet1 = DEFAULT_BULLET1;
    let bullet2 = DEFAULT_BULLET2;

    const summaryOf = (n) => {
      const s = (n.summary || n.data?.rationale || n.data?.summary || n.label || n.type || "").toString();
      return s.length > 60 ? s.substring(0, 60) + "â€¦" : s;
    };
    const lower = (s) => (s || "").toString().toLowerCase();

    for (const n of nodes) {
      const s = summaryOf(n);
      const sl = lower(s);
      if (sl.includes("falsif") || sl.includes("falsified")) {
        bullet1 = "Round 2 falsified " + (s || "hypothesis");
        break;
      }
    }
    if (bullet1 === DEFAULT_BULLET1) {
      for (const e of edges) {
        const tl = lower(e.type || e.label || "");
        if (tl.includes("falsif")) {
          const target = nodes.find(x => x.id === e.target);
          bullet1 = "Round 2 falsified " + (target ? summaryOf(target) : "hypothesis");
          break;
        }
      }
    }
    for (const n of nodes) {
      const s = summaryOf(n);
      const sl = lower(s);
      if (sl.includes("conflict detected") || sl.includes("reject") || sl.includes("rollback")) {
        bullet2 = "Round 3 recall prevented rollback";
        break;
      }
    }
    for (const e of edges) {
      const tl = lower(e.type || e.label || "");
      if (tl.includes("conflict") || tl.includes("reject") || tl.includes("rollback")) {
        bullet2 = "Round 3 recall prevented rollback";
        break;
      }
    }

    listEl.innerHTML = "<li>" + bullet1 + "</li><li>" + bullet2 + "</li>";
  }

  function updateProofFromGraph(data){
    const nodes = data.nodes || [];
    const decisionCount = nodes.filter(n => (n.label || n.type) === 'Decision').length;
    const t = I18N[LANG];
    const copyHint = t.proofCopyHint;
    document.getElementById('proofRecall').textContent = decisionCount > 0
      ? `${decisionCount} cells (includes FALSIFIED:true)`
      : copyHint;
    document.getElementById('proofConflict').textContent = 'Detected contradiction with Round 2 Falsification (Decision ID: â€¦) ' + (LANG === 'zh' ? 'â€” éœ€ä» demo.log å¤åˆ¶' : 'â€” copy from demo.log');
    document.getElementById('proofRationale').textContent = 'Conflict Detected: Rejected reverting to speed-focus; maintained quality-focus due to previous falsification. ' + (LANG === 'zh' ? 'â€” éœ€ä» demo.log å¤åˆ¶' : 'â€” copy from demo.log');
  }

  async function loadDecisionsSnapshots(){
    const t = I18N[LANG];
    try {
      const [decRes, snapRes] = await Promise.all([
        fetch(`${API_BASE}/api/v1/evidence/search`, { headers: { "X-API-Key": API_KEY } }).then(r => r.ok ? r.json() : null).catch(() => null),
        fetch(`${API_BASE}/api/v1/traces`, { headers: { "X-API-Key": API_KEY } }).then(r => r.ok ? r.json() : null).catch(() => null)
      ]);
      if (decRes || snapRes) {
        alert(t.alertDecLoaded);
        if (decRes) console.log('Evidence search:', decRes);
        if (snapRes) console.log('Traces:', snapRes);
      } else {
        alert(t.alertNoEndpoint);
      }
    } catch(e) {
      alert(t.alertLoadFail.replace("{msg}", e.message));
    }
  }

  function openApiDocs(){
    window.open(`${API_BASE}/docs`, '_blank');
  }

  let toastTimer = null;
  function showToast(title, body){
    const c = document.getElementById("toastContainer");
    c.innerHTML = '<div class="toast"><div class="toast-body"><div class="toast-title">' + (title || '').replace(/</g,'&lt;') + '</div><div class="toast-msg">' + (body || '').replace(/</g,'&lt;') + '</div></div><button class="toast-close" onclick="dismissToast()" aria-label="close">&times;</button></div>';
    c.style.display = 'block';
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(dismissToast, 3000);
  }
  function dismissToast(){
    if (toastTimer) { clearTimeout(toastTimer); toastTimer = null; }
    document.getElementById("toastContainer").style.display = 'none';
  }

  function appendUiLog(type, message){
    const el = document.getElementById("uiEventLog");
    const t = I18N[LANG];
    const prefix = (el.textContent === t.uiLogEmpty || el.textContent === "No events yet." || el.textContent === "æš‚æ— äº‹ä»¶ã€‚") ? "" : el.textContent + "\n";
    const ts = new Date().toISOString().replace('T',' ').slice(0,19);
    el.textContent = prefix + `[${ts}] ${type}: ${message}`;
  }

  async function do400Request(){
    const res = await fetch(`${API_BASE}/api/v1/decision`, {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-API-Key": API_KEY },
      body: JSON.stringify({ decision_type: "Feature_Pivot", rationale: "Demo test", citations: [], tradeoffs: "" })
    });
    const bodyText = await res.text();
    return { ok: res.status === 400, status: res.status, bodyText };
  }
  async function trigger400Demo(){
    const t = I18N[LANG];
    try {
      const r = await do400Request();
      if (r.ok) {
        showToast(t.toastTitle400, t.toastBody400);
        appendUiLog("REJECTED_400", t.uiLogRejected400);
      } else {
        const msg = t.toastUnexpected + ": HTTP " + r.status;
        showToast(msg, "");
        appendUiLog("UNEXPECTED", msg);
      }
    } catch(e) {
      showToast(t.toastNetwork, e.message || "");
      appendUiLog("NETWORK_ERROR", (e.message || "Network error"));
    }
  }
  async function runConflictDemo(){
    const t = I18N[LANG];
    const btn = document.getElementById("btnConflictDemo");
    const origText = btn.textContent;
    btn.disabled = true;
    btn.textContent = t.btnConflictDemoRunning;
    appendUiLog("demo", t.demoLogClicked);
    showToast(t.toastDemoRunning, "");
    try {
      if (typeof trigger400Demo !== "function") {
        appendUiLog("error", t.logErrorMissing);
        showToast(t.toastMissingHandler, t.toastMissingHandlerBody);
        return;
      }
      appendUiLog("demo", t.demoLogTrigger);
      const r = await do400Request();
      if (!r.ok) {
        showToast(t.toastUnexpectedResponse, "HTTP " + r.status);
        appendUiLog("warn", t.logWarnExpected400.replace("{status}", String(r.status)));
        return;
      }
      try {
        await loadTraceGraph();
        appendUiLog("demo", t.demoLogRefreshed);
        showToast(t.toastDemoCompleted, t.toastDemoCompletedBody);
      } catch(e) {
        const msg = (e && e.message) || "Could not reload trace graph.";
        showToast(t.toastRefreshFailed, msg);
        appendUiLog("error", t.logErrorRefresh.replace("{msg}", msg));
      }
    } catch(e) {
      showToast(t.toastNetworkError, t.toastNetworkErrorBody);
      appendUiLog("error", t.logErrorNetwork);
    } finally {
      btn.disabled = false;
      btn.textContent = origText;
    }
  }

  /* === Conflict Demo å®ç°è¯´æ˜ ===
   * æ–°å¢ DOMï¼šConflict History å¡ç‰‡ h4 å†…å³ä¾§æŒ‰é’® #btnConflictDemoï¼Œclass conflict-demo-btn
   * æ–°å¢å‡½æ•°ï¼šdo400Request() è¿”å› { ok, status, bodyText }ï¼›runConflictDemo() ç¼–æ’æµç¨‹
   * ç‚¹å‡»åï¼š1) appendUiLog demo æ–‡æ¡ˆ  2) è°ƒç”¨ do400Request è§¦å‘ 400  3) è‹¥ 400 åˆ™ loadTraceGraph 4) appendUiLog + showToast å®Œæˆ
   * æŒ‰é’® loadingï¼šdisabled + æ–‡æ¡ˆ Runningâ€¦ï¼Œfinally æ¢å¤
   */
</script>
</body>
</html>
